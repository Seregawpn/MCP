## Микроциклы MVP‑1 (Браузер + TTS + PTT beta)

Цель: быстрые короткие итерации (0.5–1 день) с проверяемым результатом. Фокус только на браузере, TTS и PTT beta.

### Сводный чек‑лист
- [x] C1 Навигация и ожидания
- [x] C2 Список интерактивов и детерминированная нумерация
- [x] C3 Действия по номеру (click/type/select)
- [x] C4 Автозакрытие баннеров (минимальный post‑hook)
- [x] C5 Базовые дополнения: extract + press + scroll (минимум A5)
- [x] C6 Базовый оркестратор: 1 шаг = 1 вызов, 4с пауза, ask/done, SYSTEM_PROMPT
- [ ] C7 TTS интеграция (прогресс/ask/done, barge‑in)
- [ ] C8 Надёжность: status/error/data, тайм‑ауты/ретраи, health‑check, SPA fallback
- [ ] C9 PTT beta (удержание → запись → ASR → текст)
- [ ] C10 E2E 10+ сайтов (позитивные/негативные)
 - [ ] C11 Мини‑интерфейс ассистента (CLI/SwiftUI оболочка)
 - [ ] C12 Упаковка в .app (DevID, Hardened Runtime, Notarization)
 - [ ] C13 Онбординг и доступность (VoiceOver, горячие клавиши, разрешения)
 - [ ] C14 Дистрибуция и обновления (Sparkle beta/stable) — Pro сборка
 - [ ] C15 Beta‑пилот и обратная связь (opt‑in телеметрия)

---

### C1 — Навигация и ожидания
- Цель: стабильные `browser.navigate` + `browser.wait(network_idle|ms)` на ключевых сайтах.
- Объём: 3 URL (Wikipedia, W3Schools, YouTube), 1–2 перезагрузки на каждый.
- DoD: без таймаутов/гонок, страницы загружаются последовательно.
- Тесты: простые скрипты навигации; проверка состояния после `wait`.
- Статус: done.

### C2 — Список интерактивов и детерминированная нумерация
- Цель: `browser.list_interactives`, `overlay_show/hide`, устойчивые индексы 1–30.
- Объём: нумерация во фреймах и основной странице; повторная нумерация после DOM/refresh.
- DoD: индексы стабильны при 2 последовательных refresh; пагинация списка при >30 элементов.
- Тесты: два обновления страницы на 2 сайтах; сравнение списков индексов.
- Статус: done.

### C3 — Действия по номеру (click/type/select)
- Цель: `overlay_act` по номеру с авто‑скроллом.
- Объём: ввод в поле и подтверждение (Enter) + клик по результату.
- DoD: поиск на Wikipedia/формы W3Schools проходят стабильно по номерам.
- Тесты: сценарии в `scripts/test_browser_suite.py`.
- Статус: done.

### C4 — Автозакрытие баннеров (post‑hook)
- Цель: `browser_close_banners` как автоматический пост‑hook после `navigate`/`overlay_act`.
- Зачем: оверлеи (cookie/consent/modals/chat) перекрывают контент, ломают клики и VO‑фокус.
- Стратегия: быстрый, «безопасный» клик по явным кнопкам согласия/закрытия с ограничением времени.

#### API (инструмент MCP)
```json
{
  "tool": "browser_close_banners",
  "args": {
    "time_budget_ms": 1200,
    "max_passes": 3,
    "strategy": "safe",          // safe | aggressive (по умолчанию safe)
    "languages": ["en", "ru"],    // для текстовых кнопок
    "return_details": true
  }
}
```
Ответ:
```json
{
  "status": "ok",
  "data": {
    "clicks": [
      {"type": "cookie", "label": "Accept all", "selector": "button[aria-label]", "frame": "root", "ms": 80},
      {"type": "modal", "label": "Close", "selector": ".modal .close", "frame": "frame#2", "ms": 40}
    ],
    "passes": 2,
    "elapsed_ms": 610
  }
}
```

#### Алгоритм (пост‑hook)
1) Триггеры: автоматически вызывать после `browser.navigate` и после любого успешного действия `overlay_act`/`act` (но не чаще 1 раза в 2 сек).
2) За один вызов: до `max_passes` проходов, каждый ≤ `time_budget_ms / max_passes`.
3) На каждом проходе:
   - Сканировать: корневую страницу и дочерние `frames` (глубина 1–2), частичный shadow DOM.
   - Ищем кандидаты по:
     - Профилям селекторов (ниже).
     - Семантике: `role=dialog|alertdialog`, `[aria-modal=true]`, фиксированные full‑viewport контейнеры с высоким `z-index`.
   - Внутри кандидата ищем CTA‑кнопки:
     - По текстам (multilang): "Accept all", "I agree", "OK", "Close", «Принять», «Согласен», «Закрыть».
     - По атрибутам: `[aria-label*="accept" i]`, `[data-testid*="accept" i]`, `[id*="consent" i]`.
   - Кликаем первый безопасный вариант, затем ждём 100–150 мс, повторяем поиск в пределах бюджета прохода.
4) Останавливаемся, когда: нет видимых кандидатов или время вышло.
5) Не удаляем DOM узлы, только клики; в `safe` режиме избегаем кнопок "Reject all".

#### Профили селекторов (сокр.)
```json
{
  "cookie": [
    "#onetrust-accept-btn-handler",
    "button#onetrust-accept-btn-handler",
    "button[aria-label*='accept' i]",
    "button:has-text('Accept all')",
    "button:has-text('I agree')",
    "button:has-text('Принять')",
    "button:has-text('Согласен')"
  ],
  "consent": [
    "div[role='dialog'] button:has-text('OK')",
    "[aria-modal='true'] button:has-text('Close')"
  ],
  "modal_close": [
    ".modal [aria-label='Close']",
    ".modal .close",
    "button[aria-label*='close' i]"
  ],
  "overlay": [
    "[data-testid*='consent' i] button",
    "[id*='consent' i] button"
  ]
}
```

#### Тайминги и ограничения
- Общий бюджет: `time_budget_ms` (по умолчанию 1200 мс) на весь вызов.
- Пауза после клика: 100–150 мс.
- Лимиты: `max_passes` (по умолчанию 3), `max_clicks` = 5 за вызов.
- Дросселирование: не вызывать чаще 1 раза в 2 сек на сессию.

#### Логирование
- События: `close_banners.start`, `close_banners.pass`, `close_banners.click`, `close_banners.end`.
- Поля: `frame`, `selector`, `label`, `type`, `elapsed_ms`, `pass_idx`.

#### Правила безопасности
- "Safe" режим по умолчанию: не жмём "Reject all"/"Deny"; только "Accept"/"OK"/"Close"/иконка закрытия.
- Не кликаем элементы, скрывающие оплату/проверку возраста без явного подтверждения пользователя.
- В "aggressive" режиме (не в MVP‑1): разрешить "Reject all" при запросе пользователя.

#### Тест‑план
- Позитивные: 3 сайта с cookie‑баннерами (новостные/магазины) — баннер скрыт, клики работают.
- Негативные: нет баннера — инструмент возвращает `ok` без кликов (<200 мс).
- Фреймы/shadow: сайт, где баннер во фрейме — клик успешен.
- Регрессия: повторный вызов сразу после — не превышает дросселирование.

#### DoD (для C4)
- Авто‑вызов после `navigate` и `overlay_act` включён.
- На 3 целевых сайтах баннеры закрываются (≥90%).
- На сайтах без баннера — быстрый `ok` без ложных кликов.
- Логи содержат детальную телеметрию (clicks/passes/elapsed_ms).
- Включён лимит частоты и общий бюджет времени.

Статус: done (реализовано + пост‑хук в оркестраторе; агрегатор правил — опционально)

### C5 — Базовые дополнения (минимум A5): extract + press + scroll
- Цель: сделать цикл полноценным сверх «клик/ввод».
- Объём: `browser.extract(mode=summary)` с ретраями; `browser.press(Enter/Tab/Escape/Arrow…)`; `browser.scroll(top/bottom/Δ)`.
- DoD: после навигации получается краткая сводка (2–3 предложения); формы/поиск управляются клавишами; ленивая подгрузка контента доступна.
- Тесты: 3 сайта на сводку; YouTube поиск: type → Enter; длинная страница (скролл вниз/вверх).
- Статус: done (smoke пройден: сводка/ввод+Enter/скролл)

### C6 — Базовый оркестратор
- Цель: цикл 1 шаг = 1 function_call, 4‑сек пауза, строгий SYSTEM_PROMPT (numeric‑first), `assistant_ask`/`assistant_done`.
- Объём: интерактивный CLI/скрипт; парсинг строго структурированного ответа + фоллбек‑парсер текстовых вызовов.
- DoD: 2 сценария от команды до `done` без ручных вмешательств.
- Тесты: «Дай сводку сайта», «Открой YouTube и найди хип‑хоп».
- Статус: done.

Итоги (14 Aug 2025):
- Поддержан новый формат ответа LLM: `mode: act|ask|done` (с бэкомпат с `function_call`).
- После `type` с авто‑Enter и после `overlay_act(click)` выполняется фиксированная стабилизация: `wait(4000ms)` → `list_interactives` → `overlay_show` → небольшой `sleep(100ms)` → скриншот. Модель всегда видит актуальные цифры.
- В CONTEXT добавляются `title/snippet` из результатов инструментов (например, `browser_extract`), что снижает повторы действий.
- Авто‑Enter усилен: расширенные ключевые слова и fallback; события `auto_enter`/`auto_enter_fallback` попадают в историю для LLM.
- После кликов без явной навигации (SPA) обновляем нумерацию и делаем скриншот.

### C7 — TTS интеграция
- Цель: `tts_speak/tts_stop` для прогресса, вопросов и итогов.
- Объём: macOS `say` с остановкой; уровни озвучки; barge‑in по Esc.
- DoD: слышны прогресс/ask/done; мгновенная остановка.
- Тесты: скриптовые вызовы TTS на шагах оркестратора.
- Статус: todo.

### C8 — Надёжность
- Цель: единый формат ответов `status/error/data`, тайм‑ауты/ретраи, health‑check/автоперезапуск, SPA‑fallback `wait(ms≈4000)`.
- Объём: внедрить в MCP‑инструменты и в оркестратор; логирование.
- DoD: smoke на 10 сайтах ≥90% успеха; отсутствие залипаний.
- Тесты: `scripts/site_smoke_suite.py`/`site_full_suite.py`.
- Статус: todo.

### C9 — PTT beta
- Цель: удержание клавиши → запись 16 kHz WAV → ASR (Apple Speech/Whisper) → текст цели/ответов.
- Объём: hotkey, VAD, прокидывание текста в оркестратор.
- DoD: цель и ответы на `ask` вводятся голосом стабильно.
- Тесты: голосовая команда на YouTube‑сценарий; короткие ответы на уточнения.
- Статус: todo.

### C10 — E2E 10+ сайтов
- Цель: финальная проверка качества.
- Объём: 10–12 сайтов (YouTube, Wikipedia, 2×e‑commerce, новостные, демо‑формы), позитивные и негативные кейсы.
- DoD: ≥85% успешных сценариев; ошибки логируются понятно и воспроизводимо.
- Тесты: батч‑прогон smoke/full suites.
- Статус: todo.

### C11 — Мини‑интерфейс ассистента (CLI/SwiftUI оболочка)
- Цель: дать пользователю ввод цели и видеть ход выполнения без лишнего UI.
- Объём: одно поле «Цель», лента шагов (progress + function_call), индикаторы `ask/done`, кнопки: Стоп, Повторить шаг, Озвучка вкл/выкл.
- DoD: можно ввести цель и пройти сценарий до `assistant_done`; `assistant_ask` отображается и принимает ответ.
- Тесты: два сценария из C6 проходят через UI; Esc останавливает TTS.
- Статус: todo.

### C12 — Упаковка в .app (DevID, Hardened Runtime, Notarization)
- Цель: собрать устанавливаемое macOS‑приложение.
- Объём: bundle .app, подпись Developer ID, Hardened Runtime, notarization; первый запуск — авто‑установка Playwright Chromium.
- DoD: .app запускается на чистой машине, Playwright устанавливается автоматически, все TCC‑диалоги корректны.
- Тесты: установка и запуск на 2 Mac (Intel/ARM), smoke C1–C3.
- Статус: todo.

### C13 — Онбординг и доступность (VoiceOver, горячие клавиши, разрешения)
- Цель: безопасный первый запуск и совместимость с VoiceOver.
- Объём: мастер онбординга (доступы Accessibility/Microphone/Speech/Screen Recording по необходимости), подсказки по VO, горячие клавиши (PTT, Стоп TTS, Пауза цикла).
- DoD: пользователь проходит онбординг за ≤2 мин, VO читает элементы логично, хоткеи работают.
- Тесты: проверка TCC, VoiceOver навигация по UI, горячие клавиши.
- Статус: todo.

### C14 — Дистрибуция и обновления (Sparkle beta/stable)
- Цель: безопасная раздача и обновления Pro‑версии (вне MAS).
- Объём: интеграция Sparkle, два канала (beta/stable), подпись EdDSA, appcast по HTTPS, delta‑апдейты, fallback на полную загрузку.
- DoD: апдейт с beta‑N на beta‑N+1 и со stable‑N на stable‑N+1 проходит автоматически; откат возможен вручную.
- Тесты: локальный сервер обновлений, два релиза подряд.
- Статус: todo.

### C15 — Beta‑пилот и обратная связь (opt‑in телеметрия)
- Цель: собрать обратную связь до публичного релиза.
- Объём: опциональная анонимная телеметрия (включается явно): счётчики запусков, типы шагов, длительности, коды ошибок, без PII; экспорт логов по желанию.
- DoD: минимум 5 бета‑пользователей, отчёт по метрикам/багам, список улучшений.
- Тесты: имитация отправки отчёта; проверка выключения телеметрии по умолчанию.
- Статус: todo.


