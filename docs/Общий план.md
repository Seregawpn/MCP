## Общий план проекта: Ассистент для незрячих

### Цель продукта
Создать ассистента, который не только «читает», но и «делает»: выполняет действия в браузере и с файлами, помогает с коммуникациями, работает голосом, даёт краткие сводки экрана и безопасно сопровождает многошаговые сценарии (логин/2FA, формы, вложения).

### Сквозные принципы
- **Безопасность**: подтверждения перед рискованными действиями, undo (где возможно), белые списки доменов/операций, журнал действий.
- **Приватность**: локальные модели/обработка по умолчанию, явные предупреждения при сетевых вызовах.
- **Низкая когнитивная нагрузка**: краткие озвучки «суть → результат → что дальше», регулируемая «болтливость».
- **Устойчивость**: семантические селекторы (роль/ARIA/текст), таймауты/ретраи, «сухой прогон» (plan) прежде чем исполнять.
- **Совместимость**: не конфликтовать с системными сервисами доступности (VoiceOver), режим «совместимости».

### Архитектура (MCP)
- Используем MCP Python SDK: сервер предоставляет инструменты (tools/resources), оркестратор — MCP‑клиент (план/подтверждение/логи).
- Whitelist: парсинг host при `browser.navigate`, логирование решения; политика из `config/security.yml`.
- Ретраи/backoff: обёртка для `browser.*`/`files.*` по `config/timeouts.yml`.
- Оркестратор (текущее состояние): поддержка ответа LLM в формате `mode: act|ask|done` (совместимо с `function_call`), стабилизация экрана после действий (4с wait → показ цифр → скриншот), добавление краткого `title/snippet` в сводку для LLM.

### Контракты MCP (базовые)
```json
{
  "browser.navigate": { "url": "string" },
  "browser.search": { "query": "string" },
  "browser.click": { "text": "string", "role": "string", "selector": "string", "exact": false },
  "browser.type": { "selector": "string", "text": "string", "submit": true },
  "browser.close_banners": {},
  "browser.upload": { "selector": "string", "path": "string" },
  "browser.extract": { "mode": "summary|links|forms" },
  "browser.list_interactives": { "scope": "viewport|section", "limit": 30 },
  "browser.overlay_show": { "items": [{"id": "string", "index": 1}], "scheme": "default|high-contrast" },
  "browser.overlay_hide": {},
  "browser.act": { "id": "string", "action": "click|type|select", "text": "string" },

  "files.search": { "query": "string" },
  "files.recent": { "limit": 10 },
  "files.open": { "path": "string" },
  "files.read_text": { "path": "string", "max_chars": 5000 },
  "files.ocr_pdf": { "path": "string" },
  "files.move": { "from": "string", "to": "string" },
  "files.rename": { "path": "string", "new_name": "string" },

  "apps.launch": { "name": "string" },
  "apps.activate": { "name": "string" },

  "imessage.send": { "to": ["string"], "text": "string" },
  "imessage.read_recent": { "contact": "string", "limit": 5 },

  "email.compose": { "to": ["string"], "subject": "string", "body": "string", "attachments": ["string"] },
  "email.send_draft": { "draft_id": "string" },

  "tts.speak": { "text": "string", "voice": "string", "rate": 1.0 }
}
```

Примечание: текущие имена инструментов сервера — snake_case аналоги (`browser_navigate`, `browser_close_banners`, `browser_extract`, `files_search`, `files_read_text`).

---

## Циклы MBP (каждый цикл — мини‑проект с ощутимой ценностью)

### MBP‑0. Основа и безопасность (1 неделя) — ВЫПОЛНЕНО
- Сервер MCP: `mcp_server.py` (базовые инструменты браузера/файлов).
- Оркестратор: `orchestrator_mbp0.py` (план → подтверждение → выполнение → логи через MCP).
- Whitelist: проверка host и логирование решения; `allow: ["*"]`.
- Ретраи/backoff для `browser.*`/`files.*` по конфигам.
- Демо‑скрипт: `scripts/run_demo_mbp0.sh`; логи в `agent_runs/<uuid>/`.

### MBP‑1. Браузер + TTS (обязательно) + PTT (beta): numeric‑first цикл (1 неделя)
- **Цель**: стабильный циклический ассистент в браузере по номерам, с фоллбеками, ask/done, озвучкой шагов и PTT‑вводом.
- **Функциональность**:
  - SYSTEM PROMPT: строгий формат (1 строка + 1 function_call), numeric‑first, фоллбеки, ask/done.
- Оркестратор: observe → plan → act → validate → ask/done, пауза ~4с между шагами; после действий — обязательная пере‑нумерация и скриншот до передачи контекста в LLM.
  - MCP (браузер): navigate/wait/list_interactives/overlay_show/overlay_act/find/press/scroll/close_banners(ex post‑hook)/extract/tabs/screenshot.
  - MCP (озвучка): tts_speak/tts_stop; озвучка прогресса/ask/done, barge‑in.
  - PTT beta: удержание клавиши → запись → ASR (Apple Speech/Whisper) → текст цели/ответа.
  - Логи: локально; Step Event схема и LLM‑summary.
  - **DoD/метрики**:
    - 3 сценария (сводка/видео/корзина) от натуральной команды; ≤2 уточнения; `assistant_done` корректен.
    - >90% действий по номерам; успех ≥85%; время <3–5 мин/сценарий.
  - **Демо‑скрипты**:
    - «Открой сайт → сводка» (без уточнений).
    - «YouTube: найди и запусти видео» (поиск → ввод по номеру → Enter → клик по номеру → (k) при необходимости).
    - «E‑commerce: добавить в корзину» (поиск → клик по номеру → в корзину).

### MBP‑2. Расширение MCP (Files/Apps/Email/iMessage)
– Функциональность: Files (Spotlight/CRUD/metadata), Apps (launch/activate/quit), Email (compose/send_draft), iMessage (send/read_recent).
– DoD: сценарии чтения/черновиков/запуска приложений; подтверждения уровня 2 для рисковых операций.

### MBP‑3. Чтение с экрана и «что дальше» (2 недели)
- **Цель**: снизить когнитивную нагрузку.
- **Функциональность**: сводка экрана (основные блоки, интерактивное), «следующие 2–4 шага», режимы кратко/детально; источники DOM+ARIA и OCR.
- **DoD/метрики**: полезность сводки на топ‑сайтах ≥4/5; время до нужного действия −30–50%.
- **Демо**: «Где я?», «Что доступно?», «Предложи следующий шаг», чтение секциями.

### MBP‑4. Сложные потоки: 2FA, вложения, устойчивость (1–2 недели)
- **Цель**: закрыть «боль» многошаговых сценариев.
- **Функциональность**: чтение кода из iMessage/Mail → вставка → подтверждение; улучшение upload/диалогов выбора файла; ретраи/таймауты; профили сайтов.
- **DoD/метрики**: успех логина/оплаты/бронирования с 2FA ≥80%; время −20–30% vs MBP‑1.
- **Демо**: логин с кодом из SMS/почты; загрузка файла на требовательных сайтах.

### MBP‑5. Персонализация и макросы (1 неделя)
- **Цель**: ускорять повторяющиеся рутины.
- **Функциональность**: память предпочтений (скорость TTS, детализация), пользовательские макросы/шаблоны.
- **DoD/метрики**: −30% времени на повторных задачах; ≥5 макросов стабильно работают.
- **Демо**: «оформи как обычно», «отправь шаблон…».

### MBP‑6. Каналы коммуникаций (опционально, 2 недели)
- **Цель**: расширить покрытие мессенджеров после стабилизации ядра.
- **Функциональность**: WhatsApp/Telegram/Messenger — сначала чтение/черновики через UI‑автоматизацию, позже отправка; только с подтверждениями.
- **DoD/метрики**: подтверждаемая доставка, инциденты приватности — 0.

---

## Регресс‑набор сценариев
1) «Открой сайт → найди → открой подходящее → закрой баннер → заполни форму → отправь».
2) «Найди файл → открой → прикрепи в веб‑форму → подтверждение отправки».
3) «Отправь iMessage <контакт> “<текст>”» с подтверждением.
4) «Создай письмо на <адрес> с темой/текстом и 1 вложением → черновик → отправь».
5) «Запусти/активируй Mail/Messages/Safari/Chrome/Finder».

## Таймлайн (оценка)
- MBP‑0: ВЫПОЛНЕНО; далее по плану.

## Критерий перехода между циклами
- DoD и метрики текущего цикла выполнены; регресс‑набор зелёный; инциденты приватности — 0.

## Что нужно сейчас
- Подтвердить состав MBP‑1 (браузер+файлы+apps+iMessage+e‑mail) и включение нумерации элементов (MBP‑1a/1b).
- Выбрать ASR для MBP‑2: Apple Speech (онлайн) или Whisper (офлайн).

### Платформа и дистрибуция (macOS)
- Целевая платформа: macOS 14+.
- Дистрибуция MVP‑1: Developer ID (вне MAS) с Hardened Runtime и Notarization.
- Разрешения/TCC:
  - NSMicrophoneUsageDescription (PTT),
  - NSSpeechRecognitionUsageDescription (если Apple Speech),
  - NSAppleEventsUsageDescription (автоматизация Mail/Messages/Apps),
  - Доступность (Accessibility) — пользователь включает вручную.
- Entitlements (DevID; для MAS добавляется Sandbox):
  - com.apple.security.network.client,
  - com.apple.security.automation.apple-events (с перечислением целевых bundleID в Sandbox),
  - (MAS) com.apple.security.files.user-selected.read-write.
- Технологии/библиотеки:
  - MCP Python SDK (сервер/клиент),
  - Браузер: Playwright/Chromium (DevID), для Store‑редакции — WKWebView,
  - TTS: NSSpeechSynthesizer/AVSpeechSynthesizer,
  - PTT/ASR: AVAudioEngine + VoiceProcessingIO (AEC) или WebRTC APM; webrtcvad; Apple Speech/Whisper,
  - AppleScript/osascript для Mail/Messages/Apps (DevID).
- Стратегия выпуска:
  - Pro (DevID): полная автоматизация (AppleScript, Playwright, iMessage/Mail).
  - Store (MAS, урезанная): без AppleScript/Playwright; встроенный WKWebView; только черновики/Share Sheet вместо авто‑отправки.

### Разрешения и TCC (macOS)
- Файлы/папки: доступ через NSOpenPanel/NSSavePanel + security-scoped bookmarks (для MAS). Широкий поиск — через Spotlight; чтение только по выбранным путям.
- Микрофон (PTT): NSMicrophoneUsageDescription.
- Распознавание речи (Apple Speech, если используется): NSSpeechRecognitionUsageDescription.
- Автоматизация Apple Events (Mail/Messages/Apps): NSAppleEventsUsageDescription.
- Доступность (Accessibility): пользователь включает вручную в Privacy & Security → Accessibility.
- Запись экрана (если нужны скриншоты/чтение экрана позже): пользователь включает в Privacy & Security → Screen Recording.
- Фото/Камера (при необходимости позже): NSPhotoLibraryUsageDescription, NSCameraUsageDescription.

### Entitlements
- Developer ID (MVP‑1):
  - com.apple.security.network.client
  - com.apple.security.cs.disable-library-validation (при необходимости для Playwright/встраиваний, по минимуму)
  - Hardened Runtime: включён
- Mac App Store (Store‑редакция):
  - com.apple.security.app-sandbox
  - com.apple.security.files.user-selected.read-write
  - com.apple.security.automation.apple-events (с перечислением целевых bundleID)

### Обновления и поставка (детали)
- Pro (DevID) — Sparkle auto-update:
  - Формат релиза: .dmg/.zip, подписан DevID, нотарифицирован.
  - Подпись обновлений: EdDSA (Sparkle), отдельный ключ; канал обновлений по HTTPS (appcast.xml).
  - Delta‑обновления и проверка версии; fallback на полную загрузку.
  - Политика: каналы beta/stable (два appcast), опциональные принудительные обновления для критических багов.
  - Телеметрия (опционально): анонимные сбои обновлений; выключаемая.
- Store (MAS):
  - Обновления через App Store; Sparkle не используется.

### Архитектура поставки
- MVP‑1: монолит (UI + встроенный MCP‑сервер) — проще выдача разрешений и отладка.
- Позже, при необходимости разделить:
  - Server (ядро): LaunchAgent/фоновой процесс, локальный API (WebSocket/Unix‑socket), хранит логи/настройки, централизует TCC.
  - Client (UI): тонкий слой (SwiftUI/Web), обновляется независимо, общается с сервером по локальному API.
  - Контракты: версионированные (MCP v1/v2), feature flags, миграции конфигов.
  - Обновления: server rolling с авто‑перезапуском, возможность отката на N‑1.

### Чек‑лист релиза (Pro, DevID)
- [ ] Обновить версии и build number.
- [ ] Сборка с Hardened Runtime; подпись DevID; notarization OK.
- [ ] Sparkle: обновить appcast.xml (beta/stable), загрузить архивы на HTTPS.
- [ ] Проверить автообновление с предыдущей версии (delta и полная).
- [ ] Smoke‑прогон с включенными TCC‑разрешениями (Accessibility/Microphone/Speech/Apple Events).
- [ ] Обновить README/релиз‑ноты; приложить список изменений и известных ограничений.

### Чек‑лист пользователя (первый запуск)
- Выдать доступ в Accessibility (для горячих клавиш/совместимости), при необходимости — Screen Recording.
- Подтвердить запросы: Microphone, Speech Recognition (если выбрано), Apple Events (Mail/Messages/Apps).
