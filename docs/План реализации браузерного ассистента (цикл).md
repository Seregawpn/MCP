# План реализации браузерного ассистента (циклическое выполнение через MCP)

## 0. Область и цели
- Область: ассистент, который циклически выполняет действия в браузере через MCP-инструменты, руководствуясь текстовой целью пользователя.
- Вне области: UI/UX, упаковка в .app, голос/горячие клавиши, телеметрия (рассматривать отдельно).

## 1. Архитектура и компоненты
- Оркестратор (Python): управляет циклом observe → plan → act → validate.
- LLM-клиент (Gemini): генерирует по одной команде (function_call) на итерацию.
- MCPBridge: подключение к MCP-серверу (stdio), вызовы `call_tool(name, args)`.
- Контракт инструментов: FunctionDeclaration для всех `browser_*` + локальных `assistant_*`.

## 2. Интерфейсы и контракты
- Формат итерации (обязателен):
  - Короткий прогресс-текст (1 строка, без JSON/псевдокода).
  - Ровно 1 function_call на объявленный инструмент с валидным JSON-аргументом.
- Парсинг:
  - Предпочтительно: структурированный function_call от LLM.
  - Фоллбек: текст `function_call: name=... args={...}` → JSON parse и исполнение.
- Ответы MCP-инструментов: `status: 'ok'|'error'`, `error?: string`, `data?: object`.

## 3. Набор инструментов (минимум)
- Навигация и ожидания: `browser_navigate`, `browser_wait`, `browser_back/forward/reload`.
- Нумерация и поиск: `browser_list_interactives`, `browser_overlay_show/hide`, `browser_find`, `browser_focus_next/prev`.
- Действия: `browser_overlay_act(index, action, text?)`, (крайний) `browser_act_by_index`, `browser_press`, `browser_scroll`.
- Вкладки/загрузки: `browser_open_in_new_tab`, `browser_switch_tab`, `browser_click_and_wait_download`, `browser_download_wait`, `browser_upload`.
- Диагностика: `browser_extract(mode='summary')`, `browser_screenshot`, `browser_close_banners`.
- Локальные: `assistant_done(reason)`, `assistant_ask(question)`.

## 4. Приоритеты взаимодействия
- Для действий на элементах (клик, ввод, выбор): строго по номерам через `browser_overlay_act`.
- Прочие действия (navigate/wait/scroll/extract/tabs/download/screenshot/press): свободно по необходимости.
- Фоллбеки при проблемах с номерами: `close_banners` → `scroll` → повторная нумерация (`list_interactives`+`overlay_show`) → `find` (ориентир) → снова `overlay_act`; при необходимости `press` и временно `act_by_index`.

## 5. Цикл ассистента
- Вход: цель пользователя (строка).
- Инициализация:
  - Построить SYSTEM_PROMPT с правилами (формат, приоритет «сначала цифры», ожидания, фоллбеки, done, ask).
  - Добавить FunctionDeclaration для всех инструментов.
- Итерация (макс. N итераций, напр. 20):
  1) LLM.generate (с tools): получить 1 function_call (+ краткий текст).
  2) Выполнить инструмент через MCPBridge.
  3) Авто post-action hook: до 2–3 проходов `browser_close_banners` (пер-итерационный лимит ~800 мс; общий бюджет ≤2.5 с), при успехе — обновить нумерацию при необходимости.
  4) Валидация/стабилизация:
     - Если ожидалась навигация/перерисовка: `browser_wait(network_idle=true)` (SPA: при необходимости fallback `wait(ms≈4000)`).
     - Пауза стабильности между итерациями: `browser_wait(ms=4000)`.
  5) Done/Ask:
     - Если вызван `assistant_done` — завершить цикл.
     - Если вызван `assistant_ask` — приостановить цикл до ответа пользователя, затем продолжить.
  6) Ошибки:
     - При `status='error'` → `browser_screenshot` → фоллбеки (см. п.4).

Псевдокод:
```
for i in range(MAX_STEPS):
  resp = llm.step(history, tools)
  call = get_function_call(resp) or parse_textual_call(resp.text)
  if not call: break
  result = mcp.call(call.name, call.args)
  history.add(function_response(call.name, result))
  if call.name == 'assistant_done': break
  if call.name == 'assistant_ask': wait_user_input(); history.add(user_input); continue
  auto_close_banners_with_budget()
  stabilize_wait(call)
```

## 6. Ожидания и нумерация
- Фикс‑пауза стабильности: `browser_wait(ms=4000)` после навигации, кликов и ввода с авто‑Enter.
- Порядок стабилизации перед решением LLM: `list_interactives` → `overlay_show` → (≈100 мс) → `screenshot`.
- LLM получает контекст уже с актуальными цифрами на экране (скриншот содержит оверлей), а также ITEMS(top) и краткую сводку (title/snippet) последнего шага.
- Перед `browser_overlay_act` обязательна пере‑нумерация при любых значимых DOM‑изменениях.
- На «тяжёлых» страницах — дополнительно `browser_wait(ms=4000)` перед нумерацией; при SPA — не полагаться только на `network_idle`.

## 7. Done и критерии валидации
- Done: `assistant_done(reason)` только после подтверждения (URL/title/summary/видимая реакция UI/медиа‑состояние).
- Примеры: поиск (видны результаты), видео (playing/таймер > 0), загрузка (путь файла), форма (страница успеха/summary).

## 8. Вопросы пользователю (assistant_ask)
- Вызывается, если нужна недостающая информация (логин, телефон, уточнение цели, выбор варианта).
- Цикл приостанавливается; ответ пользователя возвращает цикл к обычной итерации.
- Безопасность: не запрашивать пароли/OTP; приватные данные не логировать.

## 9. Ошибки, ретраи, таймауты
- Таймауты на вызовы MCP и LLM; экспоненциальный бэкофф на LLM.
- На ошибку инструмента: скриншот → фоллбеки → повтор попытки (ограниченно).
- Защита от зависаний MCP: health‑check, автоперезапуск сессии при фатальных сбоях.

## 10. Конфигурация
- Пауза между шагами (по умолчанию 4000 мс), лимит итераций, модель LLM, уровень логов.
- Бюджеты автозакрытия баннеров (пер-итерационный и суммарный), тайм‑ауты инструментов.

## 11. Логирование
- Прогресс‑тексты, имя инструмента, аргументы (обезличенные/маскированные), статус/ошибка, путь скриншота.
- Без контента страниц; локальное хранение, ограничение объёма/ротация.

### 11.1 Схема события шага (Step Event)
- step: номер итерации, время начала/окончания, длительность, суммарное время сценария
- call: tool name, args (маскированы), status ok/error, error text, retries
- page: url, title, nav_type (full|spa|none), active_tab, active_frame, scroll_pos
- enumerate: did_refresh (bool), items_count, summary_top5 (role/name, bbox), overlay_active (bool)
- focus/input: focused_role/name, input_ok (bool), select_ok (bool)
- find: criteria (role/text), count, top3 (role/name)
- banners: auto_close_started (bool), closed_count, spent_ms
- wait: type (ms|network_idle|selector), value, completed (bool), timeout (bool)
- media: playing (bool), last_key (e.g., 'k')
- transfer: upload_ok/error (id), download_ok/error (filename or type)
- diag: screenshot_path (on error), size
- ask: asked (bool), question (masked), user_reply (masked)

### 11.2 Сводка для LLM (LLM Summary)
- Передаём в историю не «сырые» данные, а короткую сводку сигналов:
  - title (усечённо) и snippet (первые ≈200 символов) из последнего `browser_extract`/результата инструмента
  - enumerate_count + top2(role/name), overlay_active; ITEMS(top) для ориентира
  - focus (role/name) при вводе; find_count + top2(role/name)
  - banners_closed, spent_ms, media_playing, transfer_status (dl/up)
  - last_action ok/error кратко, error_class, retries
  - remaining_budget: steps/time, banners_budget
  - note: “need_user_input” для ветвления на assistant_ask

Примечание: текущая реализация сводки уже включает title/snippet; добавление URL планируется отдельно.

## 15. Зафиксированные изменения (14 Aug 2025)
- Формат ответа LLM: добавлена поддержка схемы `mode: act|ask|done` (с обратной совместимостью с `function_call`).
- Обработка `assistant_ask`/`assistant_done` встроена в оркестратор.
- Авто‑Enter: расширены эвристики (ключевые слова, fallback) и логирование (`auto_enter`, `auto_enter_fallback`).
- После `type`+Enter и `overlay_act(click)` реализована стабилизация: 4с ожидание → `list_interactives` → `overlay_show` → скриншот.
- Скриншоты теперь делаются после показа цифр, чтобы оверлей был виден модели.
- В CONTEXT добавлены короткие поля `title/snippet` из результатов инструментов для лучшего понимания состояния страницы.
- После кликов (включая SPA) выполняется обновление нумерации и скриншот без явной навигации.
- Улучшен порядок предоставления контекста LLM: актуальные цифры + скриншот → затем решение следующего шага.

## 12. Тестирование
- Unit: парсинг structured/textual function_call, стабилизация ожиданий.
- Инструменты: навигация, нумерация, overlay_act, find, press, scroll, tabs, uploads/downloads, screenshot, close_banners.
- E2E: YouTube (поиск → воспроизведение), Wikipedia, e‑commerce (поиск → корзина), логин‑страницы (без паролей).
- Негативные: медленная сеть, баннеры, iframes/shadow DOM, SPA без network_idle.

## 13. Этапы внедрения (sprints)
- S1: Каркас оркестратора, MCPBridge, FunctionDeclaration, SYSTEM_PROMPT (numeric‑first), цикл 1‑шаг/итерация, базовая стабилизация 4с.
- S2: Фоллбеки (close_banners/scroll/re‑enumeration/find/press), авто‑hook закрытия баннеров с бюджетами, скриншоты и обработка ошибок.
- S3: Внедрить Event Logger (схема Step Event), маскировку PII, уровни логов/ротацию; LLM Summary Builder (сигналы для истории).
- S4: Tabs/downloads/uploads, SPA‑ожидания, act_by_index (крайний случай), focus‑гарантии для type/select.
- S5: assistant_ask + пауза цикла, расширенные критерии done, тесты E2E и негативные сценарии.
- S6: Health‑checks MCP/браузера, автоперезапуск, конфиг.

## 14. Готовность (DoD)
- Цели решаются на ≥10 сайтах, >90% действий по номерам; корректный done, устойчивые ожидания, авто‑закрытие баннеров, ask‑ветвления.
- Тесты зелёные; логи чистые; конфиг управляет паузами/лимитами/бюджетами.


