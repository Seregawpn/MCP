# Требования к браузерному ассистенту (MVP-1)

## 1. Назначение и область
- Цель: ассистент помогает незрячему пользователю выполнять задачи в веб-браузере, взаимодействуя ПРЕИМУЩЕСТВЕННО по НОМЕРАМ элементов (overlay) через инструменты MCP.
- Область: браузерный режим (Playwright/Chromium), без управления локальными приложениями и файлам (за рамками данного документа).

## 2. Пользовательская модель
- Пользователь формулирует цель на естественном языке (CLI/будущий голосовой режим).
- Ассистент выполняет серию коротких шагов, каждый шаг — один инструмент MCP, пока цель не достигнута или не превышены лимиты.

## 3. Контракт итерации (жесткий)
- Каждая итерация ответа ассистента состоит из:
  - Короткого прогресс-текста (1 строка, без JSON/псевдокода).
  - Ровно одного function_call на объявленный инструмент с корректными аргументами.
- Поддерживаются два формата вызова:
  1) Структурированный function_call (предпочтительно).
  2) Текстовый фоллбек: строка вида `function_call: name=... args={...}` — парсится и исполняется.

## 4. Инструменты MCP (минимальный набор)
- Навигация/стабилизация: `browser_navigate(url)`, `browser_wait(selector?, state?, network_idle?, ms?)`, `browser_back()`, `browser_forward()`, `browser_reload()`.
- Нумерация/поиск: `browser_list_interactives(scope?, limit?, offset?)`, `browser_overlay_show(scheme?)`, `browser_overlay_hide()`, `browser_find(role?, text?, limit?, offset?)`, `browser_focus_next(role?)`, `browser_focus_prev(role?)`.
- Действия: `browser_overlay_act(index, action='click'|'type'|'select', text?, limit?, offset?)`, (крайний случай) `browser_act_by_index(...)`, `browser_press(key, id?)`, `browser_scroll(to?|by_x?|by_y?|element_id?|behavior?)`.
- Вкладки/загрузки: `browser_open_in_new_tab(id)`, `browser_switch_tab(index?, title_contains?)`, `browser_click_and_wait_download(id, timeout_ms?)`, `browser_download_wait(timeout_ms?)`, `browser_upload(id, files)`.
- Диагностика: `browser_extract(mode='summary')`, `browser_screenshot(full_page=false)`, `browser_close_banners()`.
- Завершение: `assistant_done(reason)` (локальный инструмент ассистента).
 - Вопросы пользователю: `assistant_ask(question)` (локальный инструмент ассистента для уточнений).

## 5. Приоритеты взаимодействия (обновлено)
- Для ДЕЙСТВИЙ НА ЭЛЕМЕНТАХ (клик, ввод, выбор):
  - Строго по НОМЕРАМ: `browser_list_interactives` → `browser_overlay_show` → `browser_overlay_act(index, action, text?)`.
  - `browser_find(role,text)` используется ТОЛЬКО для ориентира (поиска области/контрола); само действие — всё равно через `overlay_act` по номеру.
  - `browser_act_by_index` — крайний временный выход, возвращаемся к `overlay_act` при первой возможности.
  - Фокус перед вводом: `overlay_act` с `action='type'` должен давать фокус полю; при сбое допускается `browser_press(key='Tab')` и повтор `overlay_act(type)`.
- Для НЕЭЛЕМЕНТНЫХ действий (не требуют выбора конкретного элемента):
  - Разрешены и применяются свободно по необходимости: `browser_navigate`, `browser_wait`, `browser_scroll`, `browser_extract`, `browser_close_banners`, `browser_back/forward/reload`, `browser_open_in_new_tab`, `browser_switch_tab`, `browser_click_and_wait_download`, `browser_download_wait`, `browser_screenshot`, а также `browser_press` для подтверждений/медиа/глобальных сочетаний.
- Фоллбеки при проблемах с номерами:
  - Последовательность: `browser_close_banners` → `browser_scroll` → повторная нумерация (`list_interactives` + `overlay_show`) → `browser_find` (ориентир) → снова `overlay_act`.
  - При необходимости — `browser_press` (Enter/ArrowDown/k и т.п.) и временно `browser_act_by_index`.

### 5.1 Нумерация и индексы
- Индексы `overlay_act(index, ...)` интерпретируются в рамках ПОСЛЕДНЕГО списка интерактивов и его параметров `limit/offset`.
- При изменении `limit/offset` индексация сдвигается → перед действием повторять `browser_list_interactives` с теми же `limit/offset`, затем `browser_overlay_show`.
- После навигации/значимого изменения DOM — обязательно повторять нумерацию перед любым действием по номеру.

### 5.2 Локализация и поиск ориентира (find)
- `browser_find` должен учитывать многоязычные подписи/aria-label/placeholder; сопоставление допускает частичные/регистронезависимые совпадения и нормализацию пробелов.
- `find` служит для ориентира (сужение области/поиск контрола), само действие остаётся через `overlay_act`.

## 6. Логика цикла (observe → plan → act → validate)
- Plan: модель выбирает один инструмент, формирует краткий прогресс-текст и function_call.
- Act: вызывается MCP-инструмент, результат добавляется в историю.
- Validate: при ожидании навигации — `browser_wait(network_idle=true)`; между визуальными шагами — стабилизация `browser_wait(ms≈4000)`; при необходимости `browser_extract`.
- Iterate: повторять до достижения цели, ошибки или лимитов.
 - Актуализация overlay: после навигации или значимых DOM-изменений — обязательная повторная нумерация перед действиями.
 - Press как неэлементное действие: допускается для подтверждений/медиа/навигации, но требует корректного фокуса активного элемента.
 - Ветвление на уточнение: если для продолжения не хватает данных (логин, номер телефона, нечёткая цель), допускается вызвать `assistant_ask(question)` и приостановить цикл до ответа пользователя.

## 7. Ожидания и тайминги
- Между шагами — пауза ≈ 4000 мс (`browser_wait(ms=4000)`).
- После действий, ведущих к навигации/перерисовке — `browser_wait(network_idle=true)`.
- Допустимо дополнительное ожидание перед нумерацией на «тяжелых» страницах/во фреймах.
 - SPA/динамика: на SPA `network_idle` может не наступать; допускается комбинирование `browser_wait(ms≈4000)` + повторная нумерация и/или `browser_extract` для проверки состояния.
 - Прокрутка контейнеров/iframe: при необходимости выполнять прокрутку целевого контейнера/iframe; при сомнении — общий `scroll` + повторная нумерация.

## 8. Критерии завершения (done)
- Условие: цель фактически достигнута и подтверждена сигналами (URL/title/summary/видимая реакция интерфейса).
- Действие: вызвать `assistant_done({reason})` и прекратить дальнейшие шаги.
- Запрещено вызывать done без подтверждения результата.
 - Примеры критериев:
   - Поиск: видны релевантные результаты/заголовок страницы поиска.
   - Видео: видимы контролы в состоянии воспроизведения и/или увеличивается таймер; при необходимости `browser_press(key='k')`.
   - Загрузка: получен путь сохранённого файла или событие завершения загрузки без ошибок.
   - Форма: видимо подтверждение/страница успеха/соответствующий summary.

## 9. Обработка ошибок и восстановление
- При ошибке инструмента: сделать `browser_screenshot`, затем применить фоллбеки из п.5 (close_banners → scroll → re-enumeration → find → overlay_act → press).
- Ограничители: тайм-ауты инструментов, лимит итераций (например, 20), экспоненциальный бэкофф для LLM.
- Понятные сообщения о невозможности выполнения (капчи, строгий логин и т.п.).
 - Контракт ответа инструментов: `status: 'ok'|'error'`, при `error` — поле `error: string`, опционально `data: object`.

## 10. Специальные случаи
- Видео/медиа: при необходимости использовать `browser_press(key='k')` (play/pause); подтверждать воспроизведение косвенными сигналами.
- Вкладки: открытие в новой вкладке по `id`, затем `browser_switch_tab`.
- Скачивания/загрузки: ожидание завершения, отчет о путях/статусе.
 - Iframe/контентные контейнеры: учитывать отдельные области прокрутки и фокуса, с последующей повторной нумерацией.

## 10.1 Автоматическое закрытие баннеров/куки (post-action hook)
- Цель: устранять мешающие попапы (cookie/consent/subscribe/age-gate/region) автоматически, без участия LLM.
- Триггеры запуска автозакрытия:
  - После потенциально изменяющих DOM действий: `browser_navigate`, `browser_overlay_act` с `action='click'|'select'|'type'`, `browser_reload`, `browser_open_in_new_tab`/`browser_switch_tab`.
  - При первой нумерации на новом домене.
- Поведение:
  - Выполнить до 2–3 проходов `browser_close_banners()` с суммарным бюджетом времени ≤ 1500–2500 мс.
  - Охват: основная страница, фреймы/iframe, shadow DOM.
  - После успешного закрытия — повторить нумерацию (если ранее была активна): `browser_list_interactives` → `browser_overlay_show`.
  - Если ничего не найдено — не блокировать цикл и продолжить.
  - Пер-итерационный лимит: не задерживать одну итерацию более ~800 мс на автозакрытии, если общий бюджет уже частично израсходован.
- Конфигурация:
  - По умолчанию включено; параметризуемые: включение/выключение, максимальные проходы, бюджет времени.
  - Логирование: фиксировать факты закрытия и количество найденных/закрытых элементов.
- Приватность: обработка локальная; содержимое страниц не уходит наружу.

## 11. Доступность и UX
- Высококонтрастные номера (overlay), стабильные `data-blind-id`, поддержка фреймов и shadow DOM.
- Подсказки/прогресс — краткие, бесшумные (в будущем TTS/VoiceOver).

## 12. Конфигурация
- Пауза между шагами, лимиты итераций, выбор модели LLM, уровень логирования, путь для скриншотов/загрузок.
 - Директория загрузок по умолчанию, стратегия конфликтов имён файлов (автопереименование/перезапись).
 - Бюджеты времени для автозакрытия баннеров (per-итерация и суммарный), тайм-ауты инструментов, троттлинг LLM.

## 13. Логи и приватность
- Локальные логи шагов и статусов инструментов, пути скриншотов, без контента страниц по умолчанию.
- Опциональная анонимная телеметрия — только по явному согласия (опт-ин).

## 14. Ограничения
- Строго: одна итерация = один инструмент; никаких произвольных селекторов/JS.
- Предпочтение номеров; любые альтернативы — временно и как фоллбек.
 - Конкурентность: один ассистент → один MCP-сеанс → один браузерный контекст; параллельные вызовы инструментов не допускаются.

## 16. Уточняющие вопросы ассистента (assistant_ask)
- Назначение: запрос недостающих данных у пользователя (напр. логин, номер телефона, уточнение цели, формат поиска), когда без них невозможно корректно продолжить.
- Контракт итерации: как и всегда — одна строка прогресса + один вызов:
  - Текст: краткий, что требуется уточнить.
  - Вызов: `assistant_ask({ "question": "..." })`.
- Поведение рантайма:
  - Цикл приостанавливается до получения ответа пользователя.
  - Ответ пользователя добавляется в контекст (историю) как ввод пользователя; модель продолжает обычный цикл с учётом ответа.
- Триггеры применения:
  - Отсутствуют обязательные поля для формы/логина.
  - Неясная/двусмысленная цель (нужно уточнить критерий успеха).
  - Выбор из нескольких вариантов (например, требуется подтвердить нужный пункт).
- Безопасность и приватность:
  - Не запрашивать пароли и одноразовые коды. Для таких сценариев ассистент должен объяснить ограничения и предложить вручную ввести данные напрямую в поле браузера по номеру без их проговаривания в логах.
  - Личные данные (телефон, email) не сохраняются в логах; использовать обезличивание при выводе.
- UX-требования:
  - Вопросы формулировать максимально конкретно и кратко; по одному вопросу за итерацию.
  - Если пользователь не ответил в разумный срок (конфигурируемый тайм-аут), повторить запрос один раз или завершить с объяснением.

## 15. Тестирование и DoD
- Автотесты инструментов MCP (навигация, нумерация, overlay_act, find, press, scroll, загрузки/скачивания, screenshot, close_banners).
- E2E сценарии (YouTube, Wikipedia, e-commerce: поиск → корзина → чек-аут; логин-страницы).
- Негативные сценарии (медленная сеть, баннеры, фреймы/shadow DOM).
- DoD: ассистент решает цели на 10+ сайтах; >90% действий — по номерам; корректное завершение `assistant_done(reason)`; логи чистые; тесты зеленые.


